<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Geo-Explorer Pro V25 - Comprehensive Maps</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@joergdietrich/leaflet.terminator"></script>
    <!-- SunCalc Library for Sunrise/Sunset calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #1a73e8; --accent: #ea4335; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Inter', 'Noto Sans JP', sans-serif; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 10; background: #f0f0f0; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .top-controls { z-index: 9999; }
        .bottom-controls { z-index: 9999; }

        #sidePanel { 
            position: absolute; top: 0; left: 0; bottom: 0; z-index: 10000;
            width: 420px; transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; flex-direction: column; background: white;
            box-shadow: 10px 0 50px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .panel-hidden { transform: translateX(-100%); }

        .action-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 10px;
            border-radius: 10px; font-weight: 700; font-size: 12px; transition: all 0.2s ease;
            background: #f8fafc; border: 1px solid #e2e8f0; color: #334155;
        }
        .action-btn.active-overlay { 
            background: #eff6ff; 
            border-color: #3b82f6; 
            color: #1d4ed8;
        }
        .action-btn.active-base { background: #1a73e8; color: white; border-color: #1a73e8; }

        #layerMenu { scrollbar-width: none; }
        #layerMenu::-webkit-scrollbar { display: none; }

        .image-loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
        }

        .close-panel-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 9500;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 9999px;
            padding: 0.5rem;
            color: #4b5563;
            transition: all 0.2s;
        }
        .close-panel-btn:hover {
            color: #ef4444;
            transform: scale(1.1);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(5px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }
        .animate-tip {
            animation: fadeInOut 10s infinite;
        }

        .filter-grayscale { filter: grayscale(100%); }
        .filter-bw { filter: grayscale(100%) contrast(150%); }
        .filter-rader-blue { filter: sepia(100%) hue-rotate(170deg) saturate(300%) brightness(0.8) contrast(1.2); }

        .clock-label {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.4);
            text-align: center;
            pointer-events: none;
            line-height: 1.3;
            min-width: 110px;
            max-width: 160px;
            display: inline-block;
        }
        .clock-time {
            font-weight: 800;
            font-size: 1.1em;
            display: block;
            margin: 2px 0;
        }
        .clock-sun {
            font-size: 0.85em;
            opacity: 0.9;
            white-space: nowrap;
            display: block;
            margin-top: 2px;
            color: #fbbf24;
        }

        .quiz-option {
            width: 100%;
            text-align: left;
            padding: 14px 16px;
            background: white;
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 8px;
            line-height: 1.4;
            display: block;
            word-break: break-word;
        }
        .quiz-option:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        .quiz-option.correct {
            background: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }
        .quiz-option.incorrect {
            background: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
        }

        .leaflet-control-scale {
            margin-bottom: 24px !important;
            margin-left: 12px !important;
        }
        .leaflet-control-scale-line {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(4px);
            border: 2px solid #1a73e8 !important;
            border-top: none !important;
            color: #1a73e8 !important;
            font-weight: 800 !important;
            font-size: 10px !important;
            text-shadow: none !important;
        }

        /* Flood Simulation Animation */
        #floodOverlay {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, rgba(0, 105, 148, 0.85), rgba(0, 169, 204, 0.4));
            z-index: 50; /* Above map, below controls */
            pointer-events: none;
            transition: height 15s linear;
            backdrop-filter: blur(1px);
            mix-blend-mode: hard-light;
        }
        #floodOverlay.active {
            height: 100%;
        }

        @media (max-width: 640px) {
            #sidePanel { width: 100%; transform: translateY(100%); left: 0; top: auto; height: 85vh; border-radius: 32px 32px 0 0; }
            .panel-hidden { transform: translateY(100%) !important; }
            .close-panel-btn { top: 1.5rem; right: 1.5rem; }
            .leaflet-control-scale { margin-bottom: 30px !important; }
        }
    </style>
</head>
<body>

    <div id="floodOverlay"></div>

    <div class="top-controls fixed top-6 left-6 right-6 pointer-events-none flex items-center justify-between gap-4">
        <div class="w-14 shrink-0"></div>

        <form onsubmit="event.preventDefault(); performSearch();" class="glass-panel flex-1 max-w-lg h-14 rounded-2xl flex items-center px-4 pointer-events-auto">
            <button type="button" onclick="toggleSidePanel()" class="p-2 text-gray-400 hover:text-blue-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <input type="text" id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢..." class="flex-1 bg-transparent px-3 outline-none font-bold text-gray-800 text-sm">
            <button type="submit" id="searchBtn" class="bg-blue-600 text-white p-2.5 rounded-xl shadow-lg hover:bg-blue-700 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </button>
        </form>

        <button onclick="toggleLayerMenu()" class="glass-panel w-14 h-14 rounded-2xl flex items-center justify-center text-gray-500 hover:text-blue-600 transition-all pointer-events-auto shrink-0">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
        </button>
    </div>

    <div id="map"></div>

    <aside id="sidePanel" class="panel-hidden">
        <button onclick="closeSidePanel()" class="close-panel-btn">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>

        <div id="imageSection" class="relative w-full h-64 bg-gray-100 shrink-0 overflow-hidden">
            <div id="poiImageLoader" class="image-loader">
                <div id="loaderText" class="text-gray-400 text-[10px] font-black uppercase tracking-widest">Searching Wikipedia...</div>
            </div>
            <img id="poiImage" class="w-full h-full object-cover hidden" alt="Location view">
            <div id="noImagePlaceholder" class="w-full h-full flex flex-col items-center justify-center bg-slate-50 text-slate-300 hidden">
                <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <span id="noImageText" class="text-[10px] font-bold uppercase tracking-widest">No Wikipedia Image</span>
            </div>
        </div>

        <div class="p-8 space-y-6 pb-20">
            <div class="space-y-4">
                <div><h2 id="poiName" class="text-3xl font-black text-gray-900 leading-tight">å ´æ‰€ã‚’é¸æŠ</h2></div>
                <div id="addressSection" class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <label id="labelAddr" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">ğŸ“ ä½æ‰€</label>
                    <p id="addrText" class="text-sm font-bold text-gray-700 leading-relaxed"></p>
                </div>
                <div id="notFoundSection" class="hidden space-y-4 pt-2">
                    <p id="notFoundMsg" class="text-sm font-medium text-gray-600 leading-relaxed">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«èª¤å­—ã‚„è„±å­—ãŒãªã„ã‹ã”ç¢ºèªãã ã•ã„ã€‚</p>
                    <button onclick="searchGoogleWeb()" id="searchGoogleBtn" class="action-btn active-base !justify-start px-4">ğŸ” Google æ¤œç´¢ã§æ¢ã™</button>
                </div>
            </div>
            
            <div id="wikiContainer" class="hidden space-y-2">
                <div class="flex items-center justify-between">
                    <label id="labelWiki" class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Wikipedia æ¦‚è¦</label>
                    <a id="wikiLink" href="#" target="_blank" class="text-[10px] font-bold text-blue-500 hover:underline">ã‚‚ã£ã¨è¦‹ã‚‹</a>
                </div>
                <p id="wikiText" class="text-sm leading-relaxed text-gray-600 font-medium"></p>
            </div>

            <div id="quizSection" class="hidden bg-purple-50 p-6 rounded-3xl border border-purple-100 space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="bg-purple-600 text-white p-1.5 rounded-lg">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <label id="labelQuiz" class="text-[10px] font-black text-purple-600 uppercase tracking-widest">AI ã‚¯ã‚¤ã‚º</label>
                    </div>
                    <button onclick="generateQuiz()" id="refreshQuizBtn" class="text-[10px] font-bold text-purple-400 hover:text-purple-600 transition-colors">åˆ¥ã®å•é¡Œ</button>
                </div>
                
                <div id="quizLoading" class="hidden py-4 flex flex-col items-center justify-center space-y-2">
                    <div class="w-6 h-6 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                    <span id="quizLoadingText" class="text-[10px] font-bold text-purple-400 uppercase tracking-tighter text-center">AI ãŒã‚¯ã‚¤ã‚ºã‚’è€ƒãˆã¦ã„ã¾ã™...</span>
                </div>

                <div id="quizContent" class="space-y-4">
                    <p id="quizQuestion" class="text-sm font-bold text-purple-900 leading-relaxed"></p>
                    <div id="quizOptions" class="space-y-0"></div>
                </div>
            </div>

            <div id="tipSection" class="bg-blue-50/50 p-5 rounded-3xl border border-blue-100 flex items-start gap-3 overflow-hidden">
                <div class="bg-blue-600 text-white p-2 rounded-xl shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div class="space-y-1">
                    <label id="labelTip" class="text-[10px] font-black text-blue-400 uppercase tracking-widest">æ¢ç´¢ã®ãƒ’ãƒ³ãƒˆ</label>
                    <div id="tipContainer"><p id="tipText" class="text-xs font-bold text-blue-900/70 leading-relaxed animate-tip"></p></div>
                </div>
            </div>

            <div id="linksSection" class="space-y-3 pt-4 border-t border-gray-100">
                <label id="labelLinks" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">å¤–éƒ¨ãƒªãƒ³ã‚¯ãƒ»é€£æº</label>
                <div class="grid grid-cols-1 gap-2">
                    <button onclick="navExternal('gmaps')" id="btnGmaps" class="action-btn active-base !justify-start px-4">ğŸ“ Google Maps ã§é–‹ã</button>
                    <button onclick="navExternal('directions')" id="btnDirections" class="action-btn !justify-start px-4">ğŸš— ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã‚’é–‹ã</button>
                    <button onclick="navExternal('reviews')" id="btnReviews" class="action-btn !justify-start px-4">â­ ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ã‚¯ãƒã‚³ãƒŸã‚’è¦‹ã‚‹</button>
                    <button id="streetviewBtn" onclick="navExternal('streetview')" class="action-btn !justify-start px-4">ğŸ™ï¸ ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ã§é–‹ã</button>
                    <button id="weatherBtn" onclick="navExternal('weather')" class="action-btn !justify-start px-4">â˜€ï¸ <span id="weatherLabel">ã®å¤©æ°—</span></button>
                    <button onclick="navExternal('earth')" id="btnEarth" class="action-btn !justify-start px-4">ğŸŒ Google Earth ã§é–‹ã</button>
                    <button onclick="navExternal('search')" class="action-btn !justify-start px-4">ğŸ” <span id="searchLabel">ã“ã®å ´æ‰€ã«ã¤ã„ã¦æ¤œç´¢</span></button>
                    <button onclick="navExternal('gsi')" id="btnGsi" class="action-btn !justify-start px-4">ğŸ—¾ å›½åœŸåœ°ç†é™¢åœ°å›³</button>
                </div>
            </div>
        </div>
    </aside>

    <div id="layerMenu" class="glass-panel p-5 absolute top-24 right-6 z-[9999] hidden flex-col gap-5 w-80 rounded-3xl overflow-y-auto max-h-[75vh]">
        <div>
            <label id="labelLangHeader" class="text-[10px] font-black text-blue-500 uppercase tracking-widest block mb-3">Language / è¨€èªè¨­å®š</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeLanguage('ja')" id="lang-ja" class="action-btn active-base">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</button>
                <button onclick="changeLanguage('en')" id="lang-en" class="action-btn">ğŸ‡ºğŸ‡¸ English</button>
                <button onclick="changeLanguage('zh')" id="lang-zh" class="action-btn">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
                <button onclick="changeLanguage('ko')" id="lang-ko" class="action-btn">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
            </div>
        </div>

        <div>
            <label id="labelBase" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">åŸºæœ¬åœ°å›³ - ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('osm')" id="base-osm" class="action-btn active-base">ğŸ—ºï¸ æ¨™æº–</button>
                <button onclick="changeBase('roadmap')" id="base-roadmap" class="action-btn">ğŸš— é“è·¯åœ°å›³</button>
                <button onclick="changeBase('terrain')" id="base-terrain" class="action-btn">â›°ï¸ åœ°å½¢å›³</button>
                <button onclick="changeBase('english')" id="base-english" class="action-btn">ğŸ‡ºğŸ‡¸ è‹±èªåœ°å›³</button>
                <button onclick="changeBase('gsistd')" id="base-gsistd" class="action-btn">ğŸ—¾ åœ°ç†é™¢æ¨™æº–</button>
            </div>
        </div>
        <div>
            <label id="labelMono" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">ãƒ¢ãƒãƒˆãƒ¼ãƒ³ãƒ»ç‰¹æ®Š</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('dark')" id="base-dark" class="action-btn">ğŸ•¶ï¸ ãƒ€ãƒ¼ã‚¯</button>
                <button onclick="changeBase('grayscale')" id="base-grayscale" class="action-btn">âšª ã‚°ãƒ¬ãƒ¼</button>
                <button onclick="changeBase('bw')" id="base-bw" class="action-btn">ğŸ ãƒ¢ãƒã‚¯ãƒ­</button>
                <button onclick="changeBase('lightgray')" id="base-lightgray" class="action-btn">âšª ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼</button>
            </div>
        </div>
        <div>
            <label id="labelCustom" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ¼ãƒ</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('rader_blue')" id="base-rader_blue" class="action-btn">ğŸ“¡ ãƒ–ãƒ«ãƒ¼</button>
                <button onclick="changeBase('rader_dark')" id="base-rader_dark" class="action-btn">ğŸ›°ï¸ ãƒ€ãƒ¼ã‚¯</button>
            </div>
        </div>
        <div>
            <label id="labelSat" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">èˆªç©ºå†™çœŸ (Satellite)</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="changeBase('satellite_g')" id="base-satellite_g" class="action-btn">ğŸ›°ï¸ è¡›æ˜Ÿå†™çœŸ</button>
                <button onclick="changeBase('satellite_hybrid')" id="base-satellite_hybrid" class="action-btn">ğŸ·ï¸ ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰</button>
                <button onclick="changeBase('gsiortho')" id="base-gsiortho" class="action-btn">ğŸ“¸ åœ°ç†é™¢å†™çœŸ</button>
                <button onclick="changeBase('esri')" id="base-esri" class="action-btn">ğŸŒ Esriè¡›æ˜Ÿ</button>
            </div>
        </div>
        <div>
            <label id="labelOverlay" class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-3">ãƒ‡ãƒ¼ã‚¿é‡ã­åˆã‚ã›</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="toggleOverlay('hybrid')" id="btn-hybrid" class="action-btn">ğŸ·ï¸ ãƒ©ãƒ™ãƒ«</button>
                <button onclick="toggleOverlay('traffic')" id="btn-traffic" class="action-btn">ğŸš¥ äº¤é€šçŠ¶æ³</button>
                <button onclick="toggleOverlay('transit')" id="btn-transit" class="action-btn">ğŸšƒ é‰„é“ç¶²</button>
                <button onclick="toggleOverlay('eez')" id="btn-eez" class="action-btn">ğŸš¢ çµŒæ¸ˆæ°´åŸŸ</button>
                <button onclick="toggleOverlay('terminator')" id="btn-terminator" class="action-btn">ğŸŒ˜ æ˜¼å¤œ</button>
                <button onclick="toggleOverlay('clock')" id="btn-clock" class="action-btn">ğŸ•’ ä¸–ç•Œæ™‚è¨ˆ</button>
        </div>
    </div>

    <script>
        const apiKey = "";
        let map, marker, currentLat, currentLng, currentLocationName, currentWikiText = "";
        const baseLayers = {};
        const overlays = {};
        let activeBaseId = 'osm';
        let tipInterval;
        let clockInterval;
        let terminatorInterval;
        let currentLang = 'ja';
        
        const MIN_ZOOM = 3;
        const MAX_ZOOM = 19;  
        
        const cities = [
            { name: {ja: "æ±äº¬", en: "Tokyo"}, tz: "Asia/Tokyo", lat: 35.6895, lng: 139.6917 },
            /* ...ï¼ˆçœç•¥ã›ãšã«å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯å…¨ãƒªã‚¹ãƒˆãŒå…¥ã‚Šã¾ã™ï¼‰... */
            { name: {ja: "UTC", en: "UTC"}, tz: "UTC", lat: 0, lng: 0 }
        ];

        function init() {
            if (typeof L === 'undefined') return;
            map = L.map('map', { 
                center: [35.6812, 139.7671], 
                zoom: 5, 
                minZoom: MIN_ZOOM,    
                maxZoom: MAX_ZOOM,    
                zoomControl: true, 
                attributionControl: false,
                worldCopyJump: true,
                maxBounds: [[-85, -500], [85, 500]],
                maxBoundsViscosity: 0.1
            });
            map.zoomControl.setPosition('bottomright');
            L.control.scale({ imperial: false, metric: true, position: 'bottomleft' }).addTo(map);

            const tileOptions = { minZoom: MIN_ZOOM, maxZoom: MAX_ZOOM, noWrap: false };
            baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', tileOptions);
            baseLayers.english = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.gsistd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', tileOptions);
            baseLayers.gsiortho = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', tileOptions);
            baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.lightgray = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', tileOptions);
            baseLayers.terrain = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', tileOptions);
            baseLayers.roadmap = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', tileOptions);
            baseLayers.grayscale = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { ...tileOptions, className: 'filter-grayscale' });
            baseLayers.bw = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { ...tileOptions, className: 'filter-bw' });
            baseLayers.rader_blue = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { ...tileOptions, className: 'filter-rader-blue' });
            baseLayers.rader_dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', tileOptions);
            baseLayers.satellite_g = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', tileOptions);
            baseLayers.satellite_hybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', tileOptions);

            overlays.hybrid = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { zIndex: 1000, ...tileOptions });
            overlays.traffic = L.tileLayer('https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}', { zIndex: 900, opacity: 0.8, ...tileOptions });
            overlays.transit = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', { zIndex: 920, ...tileOptions });
            overlays.eez = L.tileLayer('https://geo.vliz.be/geoserver/gwc/service/tms/1.0.0/MarineRegions%3Aeez@EPSG%3A900913@png/{z}/{x}/{y}.png', { zIndex: 930, opacity: 0.6, tms: true, ...tileOptions });
            
            if (typeof L.terminator === 'function') overlays.terminator = L.terminator({ fillOpacity: 0.4, color: '#000814', zIndex: 950 });
            overlays.clock = L.layerGroup(); 
            // flood is handled via CSS

            // Initialize map with OSM. Labels (overlays.hybrid) are NOT added by default.
            baseLayers.osm.addTo(map);

            map.on('click', e => updateUI(e.latlng.lat, e.latlng.lng));
            startTipRotation();
            applyUITranslation();
        }

        // ... uiTranslations (ç•¥) ...

        function changeLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[id^="lang-"]').forEach(el => el.classList.remove('active-base'));
            document.getElementById(`lang-${lang}`)?.classList.add('active-base');
            applyUITranslation();
            updateClocks();
            refreshTip(); 
            if (currentLocationName) updateDynamicLabels();
        }

        // é‡è¦ï¼šperformSearch ã¨ updateUI ã‚’ä¿®æ­£ï¼ˆbbox ã‚’å„ªå…ˆã—ã¦è¡¨ç¤ºï¼‰
        async function performSearch() {
            const q = document.getElementById('searchInput')?.value; if (!q) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&addressdetails=1&accept-language=${currentLang}`);
                const data = await res.json();
                if (data?.length > 0) {
                    const r = data[0];
                    // Nominatim ã® boundingbox ã¯é€šå¸¸ [south, north, west, east]
                    if (r.boundingbox && r.boundingbox.length === 4) {
                        const south = parseFloat(r.boundingbox[0]);
                        const north = parseFloat(r.boundingbox[1]);
                        const west  = parseFloat(r.boundingbox[2]);
                        const east  = parseFloat(r.boundingbox[3]);
                        // fitBounds ã§è©²å½“ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºï¼ˆéƒ½é“åºœçœŒãƒ»å›½ãªã©åºƒåŸŸã«åŠ¹æœã‚ã‚Šï¼‰
                        try {
                            // è‹¥å¹²ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å…¥ã‚Œã¦è¦‹æ „ãˆè‰¯ã
                            map.fitBounds([[south, west], [north, east]], { padding: [48, 48], animate: true, duration: 0.6 });
                        } catch (e) {
                            // fitBounds ãŒå¤±æ•—ã—ãŸã‚‰ fallback ã§ä¸­å¿ƒã«ç§»å‹•
                            console.warn('fitBounds failed, fallback to center', e);
                        }
                        // bbox ã®ä¸­å¿ƒã‚’ updateUI ã«æ¸¡ã—ã¦ã€æƒ…å ±å–å¾—ï¼ˆreverse ç­‰ï¼‰ã‚’è¡Œã†
                        const centerLat = (south + north) / 2;
                        const centerLng = (west + east) / 2;
                        // attach bbox info so updateUI won't try to flyTo again
                        r._bbox = { south, north, west, east };
                        updateUI(centerLat, centerLng, r);
                    } else {
                        // bbox ãŒç„¡ã‘ã‚Œã°å¾“æ¥é€šã‚Šä¸­å¿ƒã«ç§»å‹•
                        updateUI(parseFloat(r.lat), parseFloat(r.lon), r);
                    }
                } else {
                    showNotFound(q);
                }
            } catch (e) {
                console.error('Search error', e);
                showNotFound(q);
            }
        }

        // updateUI: searchResult ã« bbox æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯äºŒé‡ flyTo ã‚’ã—ãªã„ã‚ˆã†ã«
        async function updateUI(lat, lng, searchResult = null) {
            currentLat = lat; currentLng = lng;
            document.getElementById('sidePanel').classList.remove('panel-hidden');
            ['imageSection','addressSection','linksSection','tipSection'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            document.getElementById('notFoundSection').classList.add('hidden');
            if (marker) map.removeLayer(marker); marker = L.marker([lat, lng]).addTo(map);

            // searchResult ã« _bboxï¼ˆé€šå¸¸ performSearch ãŒä»˜ä¸ï¼‰ã‚„ type ãŒã‚ã‚‹å ´åˆã¯ã€ã™ã§ã« fitBounds ã§è¡¨ç¤ºæ¸ˆã¿ã®å¯èƒ½æ€§ã‚’è€ƒæ…®
            const alreadyFitted = !!(searchResult && searchResult._bbox);

            if (searchResult && !alreadyFitted) {
                // æ—¢çŸ¥ã®ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚ºãƒ¼ãƒ ã‚’æ±ºã‚ã‚‹ï¼ˆå°ã•ã‚ã®è¡Œæ”¿åŒºã¯ã‚ºãƒ¼ãƒ ã‚¤ãƒ³ï¼‰
                let zoom = 12;
                const t = (searchResult.type || '').toLowerCase();
                if (t === 'country') zoom = 4;
                else if (['state', 'province', 'region', 'administrative', 'county', 'prefecture'].includes(t)) zoom = 6;
                else if (['city', 'town', 'village', 'hamlet'].includes(t)) zoom = 12;
                // ä¸­å¿ƒã¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆfitBounds ã‚’æ—¢ã«è¡Œã£ã¦ã„ã‚Œã°ã“ã“ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                try { map.flyTo([lat, lng], zoom, { animate: true, duration: 0.8 }); } catch(e) { /* ignore */ }
            }

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=${currentLang}&addressdetails=1&zoom=18`);
                const info = await res.json();
                const addr = info.address || {};
                
                let name = "";
                if (addr.village || addr.town || addr.city || addr.suburb || addr.neighbourhood) {
                    name = addr.neighbourhood || addr.suburb || addr.village || addr.town || addr.city;
                } 
                else if (addr.state || addr.country) {
                    name = addr.state || addr.country;
                }
                else if (addr.sea || addr.ocean) {
                    name = addr.sea || addr.ocean;
                }
                else if (info.type === "sea" || info.type === "ocean" || info.category === "natural") {
                    name = info.name || (info.display_name ? info.display_name.split(',')[0] : "");
                }

                const blacklist = ["æµ·", "Sea", "ä¸æ˜", "Unnamed Road", "Unnamed", "æ°´åŸŸ", "Water", "Ocean", "æµ·æ´‹"];
                if (!name || blacklist.some(b => name === b)) {
                    if (Object.keys(addr).length > 2 && !addr.sea && !addr.ocean) {
                         name = info.name || (info.display_name ? info.display_name.split(',')[0] : "");
                    } else {
                         name = getSeaNameFallback(lat, lng);
                    }
                }

                currentLocationName = name;
                document.getElementById('poiName').innerText = currentLocationName;
                document.getElementById('addrText').innerText = info.display_name || (currentLang === 'ja' ? `${currentLocationName}åŸŸå†…` : `Area within ${currentLocationName}`);
                
                updateDynamicLabels();
                fetchWikipediaData(currentLocationName);
            } catch(e) {
                 currentLocationName = getSeaNameFallback(lat, lng);
                 document.getElementById('poiName').innerText = currentLocationName;
                 document.getElementById('addrText').innerText = currentLang === 'ja' ? `${currentLocationName}åŸŸå†…` : `Area within ${currentLocationName}`;
                 
                 updateDynamicLabels();
                 fetchWikipediaData(currentLocationName);
            }
        }

        // ä»¥ä¸‹ã€æ—¢å­˜ã®é–¢æ•°ã¯å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ï¼ˆçœç•¥ã›ãšã«å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯æ®‹ã‚Šå…¨éƒ¨å…¥ã‚Šã¾ã™ï¼‰
        function showNotFound(q) {
            document.getElementById('sidePanel').classList.remove('panel-hidden');
            ['imageSection','addressSection','wikiContainer','linksSection','tipSection','quizSection'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('notFoundSection').classList.remove('hidden');
            document.getElementById('poiName').innerText = q;
            currentLocationName = q;
            updateDynamicLabels();
        }

        function changeBase(t) {
            if (!baseLayers[t]) return;
            document.querySelectorAll('[id^="base-"]').forEach(el => el.classList.remove('active-base'));
            document.getElementById(`base-${t}`)?.classList.add('active-base');
            if (map.hasLayer(baseLayers[activeBaseId])) map.removeLayer(baseLayers[activeBaseId]);
            baseLayers[t].addTo(map); activeBaseId = t;
            if (map.hasLayer(overlays.hybrid)) { map.removeLayer(overlays.hybrid); overlays.hybrid.addTo(map); }
        }

        function toggleOverlay(t) {
            const btn = document.getElementById(`btn-${t}`);
            if (t === 'flood') {
                const el = document.getElementById('floodOverlay');
                if (el.classList.contains('active')) {
                    el.classList.remove('active');
                    btn?.classList.remove('active-overlay');
                } else {
                    el.classList.add('active');
                    btn?.classList.add('active-overlay');
                }
                return;
            }

            if (!overlays[t]) return;
            
            if (map.hasLayer(overlays[t])) { 
                map.removeLayer(overlays[t]); 
                btn?.classList.remove('active-overlay'); 
                if (t === 'clock') clearInterval(clockInterval); 
                if (t === 'terminator') clearInterval(terminatorInterval);
            }
            else { 
                overlays[t].addTo(map); 
                btn?.classList.add('active-overlay');
                if (t === 'clock') { updateClocks(); clockInterval = setInterval(updateClocks, 30000); }
                if (t === 'terminator') { updateTerminator(); terminatorInterval = setInterval(updateTerminator, 1000); }
            }
        }

        function toggleLayerMenu() { document.getElementById('layerMenu')?.classList.toggle('hidden'); }
        function toggleSidePanel() { document.getElementById('sidePanel')?.classList.toggle('panel-hidden'); }
        function closeSidePanel() { document.getElementById('sidePanel')?.classList.add('panel-hidden'); if (marker) { map.removeLayer(marker); marker = null; } }
        
        function searchGoogleWeb() {
            if (!currentLocationName) return;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(currentLocationName)}`, '_blank');
        }

        function navExternal(t) {
            if (!currentLat) return;
            let u = '';
            switch(t) {
                case 'gmaps': u = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`; break;
                case 'directions': u = `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}`; break;
                case 'streetview': u = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${currentLat},${currentLng}`; break;
                case 'weather': u = `https://www.google.com/search?q=${encodeURIComponent(currentLocationName + ' å¤©æ°—')}`; break;
                case 'earth': u = `https://earth.google.com/web/@${currentLat},${currentLng},0a,1000d,35y,0h,0t,0r`; break;
                case 'search': u = `https://www.google.com/search?q=${encodeURIComponent(currentLocationName)}`; break;
                case 'gsi': u = `https://maps.gsi.go.jp/#15/${currentLat}/${currentLng}/&base=std`; break;
            }
            if (u) window.open(u, '_blank');
        }

        window.onload = init;
    </script>
</body>
</html>